<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LG Electronics | Cotizador</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700;800&display=swap"
        rel="stylesheet">
    <!-- Styles -->
    <link rel="stylesheet" href="style.css?v=2024">
    <link rel="stylesheet" href="responsive.css">
    <script src="mobile-menu.js" defer></script>

    <style>
        /* Body styles are handled in style.css */


        .quote-header {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            /* Ensure layout doesn't shift */
        }

        /* Label consistency */
        .quote-header label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.85rem;
            color: #495057;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-group,
        .attribute-column {
            display: flex;
            flex-direction: column;
        }

        /* Ensure all inputs/selects have same height */
        .quote-header input[type="text"],
        .quote-header input[type="date"],
        .quote-header select {
            height: 42px;
            padding: 8px 12px;
            font-size: 0.95rem;
            border: 1px solid #ced4da;
            border-radius: 6px;
            background-color: #fff;
            transition: border-color 0.15s ease-in-out;
            width: 100%;
            box-sizing: border-box;
        }

        .quote-header input:focus,
        .quote-header select:focus {
            border-color: #A50034;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(165, 0, 52, 0.25);
        }

        .quote-header-inputs {
            display: grid;
            grid-template-columns: 100px 1fr 150px;
            gap: 1.5rem;
            align-items: start;
        }

        .header-divider {
            height: 1px;
            background-color: #f1f3f5;
            margin: 1.5rem 0;
        }

        .quote-secondary-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 2rem;
            align-items: start;
        }

        .quote-attributes {
            /* DEPRECATED - Removed in favor of quote-secondary-row */
            display: none;
        }

        .attribute-column {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .attribute-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            user-select: none;
        }

        .attribute-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #A50034;
            cursor: pointer;
        }

        .brand-checklist {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            background: #fff;
            padding: 5px;
            margin-top: 5px;
        }

        .brand-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
            color: #555;
        }

        .input-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-sizing: border-box;
        }

        .search-container {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 1rem;
        }

        .search-box {
            display: flex;
            gap: 1rem;
        }

        .search-box input {
            flex: 1;
            padding: 1rem;
            border: 2px solid #e9ecef;
            border-radius: 12px;
        }

        .search-results {
            margin-top: 1rem;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #f1f3f5;
            border-radius: 8px;
            display: none;
        }

        .result-item {
            padding: 10px 15px;
            border-bottom: 1px solid #f1f3f5;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .result-item:hover {
            background-color: #f8f9fa;
        }

        .quote-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 16px;
            overflow: hidden;
        }

        .quote-table th {
            background: #f8f9fa;
            padding: 1rem;
            text-align: left;
            font-size: 0.85rem;
        }

        .quote-table td {
            padding: 1rem;
            border-bottom: 1px solid #f1f3f5;
            vertical-align: middle;
        }

        .btn-save {
            background-color: #A50034;
            color: white;
            padding: 1rem 2rem;
            border-radius: 12px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            float: right;
            margin-top: 20px;
        }

        .user-badge {
            padding: 0.5rem 1rem;
            background: #e9ecef;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .btn-new {
            background-color: #A50034;
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }

        .hidden {
            display: none !important;
        }

        /* Edit Mode Styles */
        tr:hover {
            background-color: #f1f3f5;
        }

        .edit-icon {
            opacity: 0.5;
            margin-left: 8px;
        }

        tr:hover .edit-icon {
            opacity: 1;
            color: #A50034;
        }
    </style>
</head>

<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="brand-container">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/2/20/LG_symbol.svg" alt="LG Logo"
                        class="brand-logo">
                    <div class="brand-text">
                        <span class="brand-name">LG Electronics</span>
                        <span class="brand-tagline">Eco Solutions</span>
                    </div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <ul>
                    <li><a href="index.html"><span class="icon">‚äû</span> Dashboard</a></li>
                    <li><a href="quotes.html" class="active"><span class="icon">üìÑ</span> Cotizaciones</a></li>
                    <li id="nav-approvals"><a href="approvals.html"><span class="icon">‚úÖ</span>
                            Aprobaciones</a></li>
                    <li><a href="clients.html"><span class="icon">üë•</span> Clientes</a></li>
                    <li id="nav-prices" style="display: none;"><a href="prices.html"><span class="icon">üí≤</span>
                            Precios</a></li>
                    <li><a href="reports.html"><span class="icon">üïí</span> Reportes</a></li>
                </ul>
            </nav>

            <div class="sidebar-footer">
                <a href="#" class="footer-link"><span class="icon">‚öôÔ∏è</span> Configuraci√≥n</a>
                <a href="CRM/index.html" class="footer-link" onclick="sessionStorage.clear();"><span
                        class="icon">‚Ü™Ô∏è</span> Cerrar Sesi√≥n</a>
            </div>
        </aside>

        <main class="main-content">
            <div class="header-flex">
                <button id="mobile-menu-btn" class="mobile-menu-btn">‚ò∞</button>
                <h2>Gesti√≥n de Cotizaciones</h2>
                <div class="user-badge" id="distributorName">...</div>
            </div>

            <!-- VISTA LISTA -->
            <div id="viewList">
                <div class="search-section"
                    style="background:#fff; padding:15px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.05); margin-bottom:20px; display:flex; gap:10px; align-items:center;">
                    <input type="text" id="quoteSearchInput" placeholder="üîç Buscar por nombre de proyecto o c√≥digo..."
                        style="flex:1; padding:12px; border:1px solid #ddd; border-radius:6px; font-size:1em;"
                        onkeyup="if(event.key === 'Enter') window.searchQuotes()">
                    <button onclick="window.searchQuotes()"
                        style="background:#A50034; color:white; border:none; padding:12px 24px; border-radius:6px; cursor:pointer; font-weight:600;">Buscar</button>
                    <button onclick="window.clearSearch()"
                        style="background:#f0f0f0; color:#333; border:1px solid #ddd; padding:12px 24px; border-radius:6px; cursor:pointer;">Limpiar</button>
                </div>

                <div class="list-header">
                    <h3>Recientes (√öltimas 5)</h3>
                    <button class="btn-new" onclick="showForm()">+ Nueva Cotizaci√≥n</button>
                </div>
                <div class="quote-table-container">
                    <table class="quote-table" id="listTable">
                        <thead>
                            <tr>
                                <th>Distribuidor</th>
                                <th>Proyecto</th>
                                <th>C√≥digo</th>
                                <th>Cliente</th>
                                <th>Etapa</th>
                                <th>Fecha Award</th>
                                <th>Monto (USD)</th>
                                <th>Creador</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="7" style="text-align:center">Cargando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>


            </div>

            <!-- VISTA FORM -->
            <div id="viewForm" class="hidden">
                <div class="list-header">
                    <button onclick="showList()" style="background:none; border:none; color:#666; cursor:pointer;">‚Üê
                        Volver al listado</button>
                    <h3 style="margin:0" id="formTitle">Nueva Cotizaci√≥n</h3>
                </div>

                <div class="quote-header">
                    <!-- Top Row: Identification -->
                    <div class="quote-header-inputs" style="grid-template-columns: 100px 2fr 1fr 1fr;">
                        <div class="input-group">
                            <label>C√≥digo</label>
                            <input type="text" id="quoteCode" readonly
                                style="background:#f0f0f0; font-weight:bold; color:#A50034; text-align:center;">
                        </div>
                        <div class="input-group">
                            <label>Nombre del Proyecto</label>
                            <input type="text" id="projectName" placeholder="Ej: Edificio Costanera">
                        </div>
                        <div class="input-group">
                            <label>Etapa</label>
                            <select id="quoteStage" style="font-weight:bold;">
                                <option value="Registration">Registration</option>
                                <option value="Access">Access</option>
                                <option value="Spec/In">Spec/In</option>
                                <option value="Award">Award</option>
                                <option value="Closed">Closed</option>
                                <option value="Lost">Lost</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Fecha Award</label>
                            <input type="date" id="awardDate" required>
                        </div>
                    </div>

                    <div class="header-divider"></div>

                    <!-- Bottom Row: Stakeholders & Attributes -->
                    <!-- Bottom Row: Stakeholders & Attributes -->
                    <div class="quote-secondary-row">
                        <!-- Column 1: Companies (Customer & Consultant) -->
                        <div class="attribute-column">
                            <div class="input-group" style="margin-bottom: 1rem;">
                                <label>Cliente</label>
                                <select id="clientSelect">
                                    <option value="">Cargando...</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Consultor</label>
                                <select id="consultantSelect">
                                    <option value="">Sin Consultor / N/A</option>
                                </select>
                            </div>
                        </div>

                        <!-- Column 2: Strategy Flags -->
                        <div class="attribute-column">
                            <!-- Header for alignment -->
                            <label style="opacity:0; user-select:none;">Clasificaci√≥n</label>
                            <div style="display: flex; flex-direction: column; gap: 0.8rem; height: 100%;">
                                <div class="attribute-group"
                                    style="padding: 10px 15px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef; flex:1; display:flex; align-items:center;">
                                    <input type="checkbox" id="chkSpecIn" onchange="window.toggleBrands()"
                                        style="width: 20px; height: 20px; margin-right: 10px;">
                                    <label for="chkSpecIn"
                                        style="margin:0; cursor:pointer; text-transform:none; font-weight:500;">LG Spec
                                        In</label>
                                </div>
                                <div class="attribute-group"
                                    style="padding: 10px 15px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef; flex:1; display:flex; align-items:center;">
                                    <input type="checkbox" id="chkRetrofit"
                                        style="width: 20px; height: 20px; margin-right: 10px;">
                                    <label for="chkRetrofit"
                                        style="margin:0; cursor:pointer; text-transform:none; font-weight:500;">Es
                                        Retrofit</label>
                                </div>
                            </div>
                        </div>

                        <!-- Column 3: Brand Specification -->
                        <div class="attribute-column">
                            <!-- Brand Selection (Conditional) -->
                            <div id="brandsContainer" class="hidden" style="width: 100%;">
                                <div class="input-group">
                                    <label style="color:#A50034;">Especificado con</label>
                                    <select id="brandSelect" onchange="window.checkBrandOther()">
                                        <!-- Populated via JS -->
                                    </select>
                                    <input type="text" id="brandOtherInput" placeholder="Nombre de la marca..."
                                        style="display:none; margin-top:8px;">
                                </div>
                            </div>

                            <!-- Success Banner (Visible if Spec In is TRUE) -->
                            <div id="specInSuccess" class="hidden"
                                style="display:flex; align-items:center; justify-content:center; height:100%; color: #2e7d32; background: #e8f5e9; border-radius: 8px; border: 1px solid #c8e6c9;">
                                <div style="text-align:center;">
                                    <div style="font-size:1.5rem;">‚úì</div>
                                    <div style="font-weight: bold; font-size:0.9rem;">Especificado con LG</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="search-container">
                    <div class="input-group">
                        <label>Buscar Producto</label>
                        <div class="search-box">
                            <input type="text" id="productSearch" placeholder="Escribe 'Multi V' o Modelo...">
                            <button id="btnSearch"
                                style="padding:0 15px; cursor:pointer; background:#eee; border:none; border-radius:8px;">üîç</button>
                        </div>
                    </div>
                    <div id="searchResults" class="search-results"></div>
                </div>

                <div class="quote-table-container">
                    <table class="quote-table" id="quoteTable">
                        <thead>
                            <tr>
                                <th style="width:15%">Modelo</th>
                                <th>Desc.</th>
                                <th>
                                    Delivery Date
                                    <button onclick="window.fillDates()" title="Copiar fecha del primero a todos"
                                        style="background:none; border:none; cursor:pointer; color:#A50034; font-weight:bold;">‚ñº</button>
                                </th>
                                <th style="text-align:right;">Precio Lista (USD)</th>
                                <th>Desc %</th>
                                <th style="text-align:right;">Neto (USD)</th>
                                <th>Cant.</th>
                                <th style="text-align:right;">Total (USD)</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody><!-- Items --></tbody>
                    </table>
                    <div style="text-align:right; margin-top:20px; font-size:1.5rem; font-weight:bold;">
                        Total: <span id="grandTotal">$0.00</span>
                    </div>
                    <button class="btn-save" id="btnSave">Guardar Cotizaci√≥n</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Delete Request Modal -->
    <div id="deleteModal" class="modal-overlay hidden"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; z-index:1000;">
        <div class="modal-content"
            style="background:white; padding:2rem; border-radius:12px; width:400px; max-width:90%;">
            <h3>Solicitar Eliminaci√≥n / P√©rdida</h3>
            <p>Indique la raz√≥n para dar de baja esta oportunidad:</p>
            <textarea id="deleteReasonInput" rows="4"
                style="width:100%; margin:1rem 0; padding:0.5rem; border:1px solid #ccc; border-radius:4px;"></textarea>
            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button onclick="closeDeleteModal()"
                    style="padding:8px 16px; border:1px solid #ccc; background:white; cursor:pointer; border-radius:4px;">Cancelar</button>
                <button onclick="confirmDeleteRequest()"
                    style="padding:8px 16px; background:#A50034; color:white; border:none; cursor:pointer; border-radius:4px;">Enviar
                    Solicitud</button>
            </div>
        </div>
    </div>

    <!-- Script at bottom -->
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script>
        const supabaseUrl = 'https://efbkehhayoxceutvdekw.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVmYmtlaGhheW94Y2V1dHZkZWt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMzc0NDIsImV4cCI6MjA4NTcxMzQ0Mn0.nPpkLYX-VcUjrAp47xfaIHhUN5U-PfLbjjrdTt38_k0';

        let db;
        let currentUser = null;
        let myDistributorId = null;
        let myDiscounts = {};
        let quoteItems = [];
        let isAdmin = false;
        let targetQuoteIdForDelete = null;

        // Render Action Buttons based on Stage & Role
        function renderActionButtons(q) {
            if (q.stage === 'Delete_Pending' || q.stage === 'Lost_Pending') {
                if (isAdmin) {
                    return `
                        <div style="display:inline-flex; gap:5px;">
                            <button onclick="event.stopPropagation(); approveDelete('${q.id}', '${q.stage}')" title="Aprobar" style="background:#28a745; color:white; border:none; border-radius:4px; padding:4px 8px; cursor:pointer;">‚úì</button>
                            <button onclick="event.stopPropagation(); rejectDelete('${q.id}')" title="Rechazar" style="background:#6c757d; color:white; border:none; border-radius:4px; padding:4px 8px; cursor:pointer;">‚úï</button>
                        </div>
                    `;
                } else {
                    return `<span style="font-size:0.8em; color:#d63384; font-weight:bold;">‚è≥ Pendiente Aprobaci√≥n Admin</span>`;
                }
            } else if (q.stage === 'Lost') {
                return `<span style="font-size:0.8em; color:#6c757d; font-weight:bold;">Perdida</span>`;
            } else {
                return `
                    <button onclick="event.stopPropagation(); requestDelete('${q.id}')" 
                            title="Solicitar Baja"
                            style="background:#A50034; color:white; border:none; border-radius:4px; cursor:pointer; padding:4px 8px;">
                        üóë
                    </button>
                `;
            }
        }

        // Delete Workflow Functions
        window.requestDelete = (id) => {
            targetQuoteIdForDelete = id;
            document.getElementById('deleteReasonInput').value = '';
            document.getElementById('deleteModal').classList.remove('hidden'); // Remove class first (if used CSS class logic)
            document.getElementById('deleteModal').style.display = 'flex'; // Ensure inline style override
        };

        window.closeDeleteModal = () => {
            targetQuoteIdForDelete = null;
            document.getElementById('deleteModal').style.display = 'none';
        };

        window.confirmDeleteRequest = async () => {
            const reason = document.getElementById('deleteReasonInput').value.trim();
            if (!reason) return alert("Debe ingresar una raz√≥n.");

            const { error } = await db.from('quotes').update({
                stage: 'Delete_Pending',
                loss_reason: reason,
                requested_by: currentUser.id
            }).eq('id', targetQuoteIdForDelete);

            if (error) {
                console.error(error);
                alert("Error al solicitar baja: " + error.message);
            } else {
                alert("Solicitud enviada para aprobaci√≥n del administrador.");
                closeDeleteModal();
                loadRecentQuotes(); // Refresh list
            }
        };

        window.approveDelete = async (id, stage) => {
            if (stage === 'Lost_Pending') {
                if (!confirm("¬øConfirmar que esta oportunidad est√° PERDIDA (Lost)?")) return;
                const { error } = await db.from('quotes').update({ stage: 'Lost' }).eq('id', id);
                if (error) alert("Error: " + error.message);
                else loadRecentQuotes();
            } else {
                if (!confirm("¬øConfirmar ELIMINACI√ìN de esta cotizaci√≥n del sistema?")) return;
                await db.from('quote_items').delete().eq('quote_id', id);
                const { error } = await db.from('quotes').delete().eq('id', id);
                if (error) alert("Error: " + error.message);
                else {
                    alert("Cotizaci√≥n eliminada del sistema.");
                    loadRecentQuotes();
                }
            }
        };

        window.rejectDelete = async (id) => {
            if (!confirm("¬øRechazar solicitud y devolver a 'Registration'?")) return;
            // Revert to Registration (or maybe keep existing, but simplified logic per request)
            const { error } = await db.from('quotes').update({
                stage: 'Registration'
            }).eq('id', id);

            if (error) alert("Error: " + error.message);
            else loadRecentQuotes();
        };

        // Auto-Run
        (async function initSystem() {
            try {
                if (typeof window.supabase === 'undefined') {
                    throw new Error("Supabase JS no carg√≥ (Verifique Conexi√≥n)");
                }
                db = window.supabase.createClient(supabaseUrl, supabaseKey);

                // --- AUTH CHECK ---
                const { data: { user }, error: authError } = await db.auth.getUser();
                if (authError || !user) {
                    console.warn("No active session. Redirecting...");
                    window.location.href = 'CRM/index.html';
                    return;
                }
                currentUser = user;

                // --- LOGOUT HANDLER (Badge Click) ---
                const badge = document.querySelector('.user-badge');
                if (badge) {
                    badge.style.cursor = 'pointer';
                    badge.title = 'Clic para cerrar sesi√≥n';
                    badge.onclick = async () => {
                        if (confirm("¬øCerrar sesi√≥n?")) {
                            await db.auth.signOut();
                            sessionStorage.clear();
                            window.location.href = 'CRM/index.html';
                        }
                    };
                }

                // Check access for Approvals Link
                if (true) {
                    const nav = document.getElementById('nav-approvals');
                    if (nav) nav.style.display = 'block';
                }

                await loadProfileData();

                if (myDistributorId || isAdmin) {
                    await loadRecentQuotes();
                    await loadClients();
                    await loadConsultants();
                }

                await loadBrands();
                setupSearch();
                document.getElementById('btnSave').addEventListener('click', saveQuote);

            } catch (e) {
                console.error(e);
                alert("Error de Sistema: " + e.message);
            }
        })();

        async function loadProfileData() {
            const badge = document.getElementById('distributorName');

            // Hardcoded check for super admin
            if (currentUser.email === 'admin@lge.com') {
                isAdmin = true;
                myDistributorId = null;
                badge.textContent = "ADMINISTRADOR (VISTA GLOBAL)";

                // Show prices link
                const navPrices = document.getElementById('nav-prices');
                if (navPrices) navPrices.style.display = 'block';

                return;
            }

            const { data: profile, error } = await db.from('profiles').select('role, distributor_id').eq('id', currentUser.id).single();
            if (error) {
                console.error("Profile load error", error);
                return;
            }

            myDistributorId = profile.distributor_id;
            isAdmin = (profile.role === 'admin');

            if (isAdmin) {
                badge.textContent = "ADMINISTRADOR/GERENTE";
                // Show prices link
                const navPrices = document.getElementById('nav-prices');
                if (navPrices) navPrices.style.display = 'block';
            } else {
                if (myDistributorId) {
                    const { data: comp } = await db.from('companies').select('name').eq('id', myDistributorId).single();
                    badge.textContent = comp ? comp.name : "Distribuidor";
                } else {
                    badge.textContent = "Sin Empresa Asignada";
                }
            }
        }

        // Helper to Render Table
        async function renderQuotesList(quotes) {
            const tbody = document.querySelector('#listTable tbody');

            if (!quotes || !quotes.length) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:20px;">No se encontraron cotizaciones.</td></tr>';
                return;
            }

            // Fetch Relations (Clients & Users)
            const clientIds = [...new Set(quotes.map(x => x.client_id).filter(Boolean))];
            let clientsMap = {};
            if (clientIds.length) {
                const { data: cs } = await db.from('clients').select('id, company_name').in('id', clientIds);
                if (cs) cs.forEach(c => clientsMap[c.id] = c.company_name);
            }

            const userIds = [...new Set(quotes.map(x => x.user_id).filter(Boolean))];
            let usersMap = {};
            if (userIds.length > 0) {
                const { data: us } = await db.from('profiles').select('id, full_name').in('id', userIds);
                if (us) us.forEach(u => usersMap[u.id] = u.full_name || 'Usuario');
            }

            // Fetch Distributors
            const distIds = [...new Set(quotes.map(x => x.distributor_id).filter(Boolean))];
            let distMap = {};
            if (distIds.length) {
                const { data: ds } = await db.from('companies').select('id, name').in('id', distIds);
                if (ds) ds.forEach(d => distMap[d.id] = d.name);
            }

            tbody.innerHTML = '';
            quotes.forEach(q => {
                const cur = q.total_net_price
                    ? '$' + q.total_net_price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
                    : '$0.00';

                const distName = distMap[q.distributor_id] || (q.distributor_id ? 'Desconocido' : 'Directo LG');

                const tr = document.createElement('tr');
                tr.style.cursor = 'pointer';
                tr.onclick = (e) => {
                    // Avoid triggering if clicked on action buttons
                    if (e.target.tagName === 'BUTTON') return;
                    editQuote(q.id);
                };

                tr.innerHTML = `
                    <td style="font-weight:bold; color:#555;">${distName}</td>
                    <td><strong>${q.project_name || '-'}</strong> <span class="edit-icon">‚úé</span></td>
                    <td>${q.quote_code || '---'}</td>
                    <td>${clientsMap[q.client_id] || '-'}</td>
                    <td><span class="badge-stage ${q.stage?.toLowerCase().replace('/', '-') || 'registration'}">${q.stage?.replace('_', ' ') || 'Registration'}</span></td>
                    <td>${q.award_date || '-'}</td>
                    <td>${cur}</td>
                    <td>${usersMap[q.user_id] || 'Usuario'}</td>
                    <td>
                        <button onclick="event.stopPropagation(); window.generatePDF('${q.id}')" 
                                class="btn-icon" title="Descargar PDF" 
                                style="background:#0052cc; color:white; border:none; border-radius:4px; cursor:pointer; padding:4px 8px; margin-right:5px;">
                            üìÑ PDF
                        </button>
                        ${renderActionButtons(q)}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function loadRecentQuotes() {
            const h3 = document.querySelector('.list-header h3');
            if (h3) h3.textContent = "Recientes (√öltimas 5)";

            let q = db.from('quotes').select('*').order('created_at', { ascending: false }).limit(5);
            if (!isAdmin) q = q.eq('distributor_id', myDistributorId);

            const { data: quotes, error } = await q;
            if (error) { console.error(error); return; }
            await renderQuotesList(quotes);
        }

        window.searchQuotes = async () => {
            const query = document.getElementById('quoteSearchInput').value.trim();
            if (!query) return loadRecentQuotes();

            const h3 = document.querySelector('.list-header h3');
            if (h3) h3.textContent = `Resultados para: "${query}"`;

            // Search by project_name OR quote_code
            let q = db.from('quotes').select('*')
                .or(`project_name.ilike.%${query}%,quote_code.ilike.%${query}%`);

            if (!isAdmin) q = q.eq('distributor_id', myDistributorId);

            q = q.order('created_at', { ascending: false })
                .limit(50);

            if (!isAdmin) q = q.eq('distributor_id', myDistributorId);

            const { data: quotes, error } = await q;
            if (error) {
                console.error("Search error:", error);
                alert("Error buscando cotizaciones.");
                return;
            }
            await renderQuotesList(quotes);
        };

        window.clearSearch = () => {
            document.getElementById('quoteSearchInput').value = '';
            loadRecentQuotes();
            // Reset focus
            document.getElementById('quoteSearchInput').focus();
        };

        async function editQuote(id) {
            try {
                // Fetch Details
                const { data: q, error: qe } = await db.from('quotes').select('*').eq('id', id).single();
                if (qe) throw qe;

                // Fetch Items (No Join used to prevent Schema Error, manual fetch)
                const { data: items, error: ie } = await db.from('quote_items').select('*').eq('quote_id', id);
                if (ie) throw ie;

                // Manual Fetch Products
                const pIds = items.map(i => i.product_id);
                let productsMap = {};
                if (pIds.length > 0) {
                    const { data: prods, error: pe } = await db.from('products').select('*').in('id', pIds);
                    if (pe) throw pe;
                    prods.forEach(p => productsMap[p.id] = p);
                }

                // Set Edit Mode
                currentQuoteId = id;
                document.getElementById('formTitle').textContent = "Editar Cotizaci√≥n " + q.quote_code;

                document.getElementById('viewList').classList.add('hidden');
                document.getElementById('viewForm').classList.remove('hidden');

                document.getElementById('quoteCode').value = q.quote_code;
                document.getElementById('projectName').value = q.project_name;
                document.getElementById('clientSelect').value = q.client_id || "";
                document.getElementById('clientSelect').value = q.client_id || "";
                document.getElementById('awardDate').value = q.award_date;
                document.getElementById('quoteStage').value = q.stage || "Registration";

                // Set New Fields
                document.getElementById('consultantSelect').value = q.consultant_id || ""; // Load ID
                document.getElementById('chkSpecIn').checked = q.is_spec_in || false;
                document.getElementById('chkRetrofit').checked = q.is_retrofit || false;

                window.toggleBrands();

                // Set Brands
                // Previously logic used checkboxes, now uses Select
                const savedBrands = q.specified_brands || [];
                const savedBrand = savedBrands.length > 0 ? savedBrands[0] : "";

                const select = document.getElementById('brandSelect');
                const input = document.getElementById('brandOtherInput');

                // Try to find if saved brand exists in options
                let found = false;
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value === savedBrand) {
                        select.selectedIndex = i;
                        found = true;
                        break;
                    }
                }

                // If not found (and not empty), it means it's a custom "Other" value
                if (!found && savedBrand) {
                    select.value = "Otros";
                    input.value = savedBrand;
                } else {
                    // Reset input if standard brand
                    input.value = "";
                }
                window.checkBrandOther();

                // Reconstruct Items
                quoteItems = items.map(i => {
                    const prod = productsMap[i.product_id] || { model_short: 'Unknown', list_price: 0, description: '', category: 'Unknown' };
                    return {
                        product: prod,
                        qty: i.quantity,
                        disc: i.applied_discount,
                        net: i.final_unit_price,
                        delivery_date: i.delivery_date || ''
                    };
                });
                render();

            } catch (e) {
                alert("Error cargando cotizaci√≥n: " + e.message);
            }
        }

        async function loadClients() {
            const s = document.getElementById('clientSelect');

            // Logic: Clients list should show Installers OR End Users.
            // Consultants (who are ONLY consultants) should be excluded.
            // Supabase 'or' query formatting: "is_installer.eq.true,is_end_user.eq.true"
            let q = db.from('clients').select('id, company_name, distributor_id') // Added distributor_id
                .or('is_installer.eq.true,is_end_user.eq.true');

            if (!isAdmin) q = q.eq('distributor_id', myDistributorId);

            const { data: c, error } = await q;

            if (error) {
                console.error("Error loading clients:", error);
                return;
            }

            s.innerHTML = '<option value="">Seleccione...</option>';
            if (c) {
                // Sort alphabetically
                c.sort((a, b) => a.company_name.localeCompare(b.company_name));

                c.forEach(x => {
                    let o = document.createElement('option');
                    o.value = x.id;
                    o.textContent = x.company_name;
                    // Store distributor info for Admins who don't have their own distributor_id
                    if (x.distributor_id) o.dataset.distributorId = x.distributor_id;
                    s.appendChild(o)
                });
            }
        }

        window.showForm = () => {
            currentQuoteId = null;
            document.getElementById('formTitle').textContent = "Nueva Cotizaci√≥n";
            document.getElementById('viewList').classList.add('hidden');
            document.getElementById('viewForm').classList.remove('hidden');
            document.getElementById('quoteCode').value = 'CH' + Math.floor(10000 + Math.random() * 90000);
            quoteItems = []; render();
            document.getElementById('projectName').value = '';
            document.getElementById('projectName').value = '';
            document.getElementById('awardDate').value = '';
            document.getElementById('quoteStage').value = "Registration";
            document.getElementById('clientSelect').value = "";
            document.getElementById('projectName').value = '';
            document.getElementById('awardDate').value = '';
            document.getElementById('clientSelect').value = "";
            document.getElementById('consultantSelect').value = "";
            document.getElementById('consultantSelect').value = "";
            document.getElementById('chkSpecIn').checked = false;
            document.getElementById('chkRetrofit').checked = false;
            document.getElementById('brandSelect').value = "";
            window.checkBrandOther();
            window.toggleBrands();
        };
        window.showList = async () => {
            document.getElementById('viewForm').classList.add('hidden');
            document.getElementById('viewList').classList.remove('hidden');
            await loadRecentQuotes();
        };

        // PDF Generation
        window.generatePDF = async (id) => {
            const deliveryDate = prompt("Ingrese la Fecha Estimada de Entrega (ej. 2026-04-29):", new Date().toISOString().split('T')[0]);
            if (deliveryDate === null) return; // Cancelled

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Helper to load image
                const getLogo = async () => {
                    try {
                        const response = await fetch('https://upload.wikimedia.org/wikipedia/commons/thumb/2/20/LG_symbol.svg/200px-LG_symbol.svg.png');
                        const blob = await response.blob();
                        return new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onloadend = () => resolve(reader.result);
                            reader.readAsDataURL(blob);
                        });
                    } catch (e) {
                        console.warn("Could not load logo", e);
                        return null;
                    }
                };
                const logoData = await getLogo();

                // --- Helper: Print Header Logo ---
                const printHeaderLogo = () => {
                    let symbolDrawn = false;
                    // Draw Symbol
                    if (logoData) {
                        try {
                            doc.addImage(logoData, 'PNG', 14, 11, 10, 10); // Smaller 10x10
                            symbolDrawn = true;
                        } catch (e) { console.warn(e); }
                    } else {
                        // Fallback Symbol Placeholder
                        doc.setFillColor(165, 0, 52);
                        doc.circle(19, 16, 5, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(8);
                        doc.text("LG", 17, 18);
                    }

                    // Draw Text "LG" only
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(22);
                    doc.setTextColor(50, 50, 50); // Dark Grey
                    doc.text("LG", 26, 19);
                };

                // 1. Fetch Quote & Client
                // 1. Fetch Quote & Client (Buyer)
                // Fix: Ambiguous FK (client_id vs consultant_id). We specify 'clients!client_id'
                const { data: q, error: qErr } = await db.from('quotes').select(`
                *,
                clients!client_id (company_name, contact_name, address)
            `).eq('id', id).single();

                if (qErr) throw qErr;

                // 2. Fetch Profile & Distributor Manually
                let sellerName = 'Ejecutivo';
                let distributorId = q.distributor_id; // Direct link first

                if (q.user_id) {
                    const { data: userProfile } = await db.from('profiles').select('full_name, distributor_id').eq('id', q.user_id).single();
                    if (userProfile) {
                        sellerName = userProfile.full_name;
                        // Fallback: If quote heavily relies on creator context
                        if (!distributorId && userProfile.distributor_id) {
                            distributorId = userProfile.distributor_id;
                        }
                    }
                }

                let recipientName = q.clients?.company_name || "Cliente";

                // If quote is linked to a Distributor (directly or via creator), address it to the Distributor
                if (distributorId) {
                    const { data: dist } = await db.from('companies').select('name').eq('id', distributorId).single();
                    if (dist) recipientName = dist.name;
                }

                // 3. Fetch Items
                const { data: items, error: iErr } = await db.from('quote_items').select('*').eq('quote_id', id);
                if (iErr) throw iErr;

                // 4. Fetch Products Manually
                const productIds = [...new Set(items.map(i => i.product_id).filter(Boolean))];
                let productsMap = {};
                if (productIds.length > 0) {
                    const { data: prods } = await db.from('products').select('id, model_short, description, category').in('id', productIds);
                    if (prods) prods.forEach(p => productsMap[p.id] = p);
                }

                // --- HEADER (First Page) ---
                printHeaderLogo();

                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");

                const today = new Date().toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
                doc.text(today, 150, 20); // Top Right Date

                // Recipient Info
                doc.setFont("helvetica", "bold");
                doc.text("Se√±ores", 14, 45);
                doc.text(recipientName, 14, 50);
                doc.setFont("helvetica", "normal");
                doc.text("Presente", 14, 55);

                // Quote Info
                doc.text(`At: ${sellerName}`, 130, 50);
                doc.setFont("helvetica", "bold");
                doc.text(`Cotizaci√≥n: ${q.quote_code}`, 130, 55);

                // Project Info
                doc.setFont("helvetica", "normal");
                doc.text(`Proyecto: ${q.project_name}`, 14, 75);
                doc.text(`Fecha estimada de entrega:   ${deliveryDate}`, 14, 80);

                // Table Rows
                const tableBody = items.map(i => {
                    const prod = productsMap[i.product_id] || {};
                    return [
                        prod.model_short || 'N/A',
                        prod.description || '',
                        i.quantity,
                        '$' + i.final_unit_price.toLocaleString('de-DE'),
                        '$' + i.total_line_price.toLocaleString('de-DE')
                    ];
                });

                doc.autoTable({
                    startY: 90,
                    head: [['Modelo', 'Descripcion', 'Cantidad', 'P.Unit', 'Total']],
                    body: tableBody,
                    theme: 'plain',
                    headStyles: { fillColor: [0, 0, 0], textColor: [255, 255, 255], fontStyle: 'bold' },
                    styles: { fontSize: 9, cellPadding: 2, valign: 'middle' },
                    columnStyles: {
                        0: { cellWidth: 35 },
                        1: { cellWidth: 'auto' },
                        2: { cellWidth: 20, halign: 'center' }, // Increased width for "Cantidad"
                        3: { cellWidth: 25, halign: 'right' },
                        4: { cellWidth: 25, halign: 'right' }
                    },
                    margin: { right: 14, left: 14 }
                });

                // Total
                let finalY = doc.lastAutoTable.finalY + 10;
                doc.setFont("helvetica", "bold");
                const totalStr = '$' + (q.total_net_price || 0).toLocaleString('de-DE');

                // Align Total Value to the right margin (approx 196mm for A4)
                const pageWidth = doc.internal.pageSize.width;
                const rightMargin = 14;

                doc.text("VALOR NETO TOTAL (USD)", 14, finalY);
                doc.text(totalStr, pageWidth - rightMargin - 2, finalY, { align: "right" }); // Aligned to right

                doc.setLineWidth(0.5);
                doc.line(14, finalY + 2, pageWidth - rightMargin, finalY + 2); // Underline full width

                // --- CONDITIONS ---
                let y = finalY + 15;

                const checkPage = (h) => {
                    if (y + h > 270) {
                        doc.addPage();
                        y = 35; // Increased margin to avoid header overlap
                    }
                };

                doc.setFontSize(9); // Consistent size
                doc.setTextColor(0, 0, 0);

                checkPage(10);
                doc.setFont("helvetica", "bold");
                doc.text("CONDICIONES COMERCIALES", 14, y); y += 6;

                const conditionsData = [
                    {
                        title: "GENERALIDADES",
                        points: [
                            "Es responsabilidad de la empresa dise√±adora asegurar el cumplimiento de la normativa local y/o internacional (Referencia: Est√°ndares ASHRAE) conforme a los requerimientos del cliente final.",
                            "Es responsabilidad de la empresa dise√±adora asegurar el cumplimiento de los requerimientos mandatorios del sistema VRF LG Multi V. Disponemos de herramientas de ingenier√≠a gratis a vuestra disposici√≥n para evitar posibles problemas te√≥ricos.",
                            "Es responsabilidad de la empresa instaladora asegurar que el equipamiento solicitado cumple las caracter√≠sticas t√©cnicas del proyecto.",
                            "Es responsabilidad de la empresa instaladora confirmar en terreno si el sistema proyectado es apto para construcci√≥n.",
                            "Es responsabilidad de la empresa instaladora corroborar en nuestras herramientas de ingenier√≠a (Referencia: LATS HVAC) cualquier modificaci√≥n que se manifieste en obra y que ponga en riesgo el cumplimiento de los requerimientos mandatorios especificados en nuestros manuales de ingenier√≠a.",
                            "Es responsabilidad de la empresa instaladora mantener actualizados los diagramas de ca√±er√≠as, fuerza y control (Referencia: LATS HVAC).",
                            "LG Electronics Chile Ltda. no acepta ning√∫n monto a pagar por concepto de penalidad o compensaci√≥n por da√±os como consecuencia de la demora en la entrega de productos."
                        ]
                    },
                    {
                        title: "ENTREGA",
                        points: [
                            "120 d√≠as v√≠a mar√≠tima desde Corea, una vez recibida OC aprobada y diagramas (Referencia: LATS HVAC) firmados.",
                            "El tiempo de entrega comienza a correr desde el d√≠a siguiente de la confirmaci√≥n y aceptaci√≥n de la orden de compra por parte de LG Electronics Chile Ltda.",
                            "La obligaci√≥n de entregar los productos se tiene por cumplida una vez que los equipos han sido entregados en la direcci√≥n se√±alada en la OC y deber√° necesariamente encontrarse en Santiago de Chile. Otras zonas se pueden cotizar, previa evaluaci√≥n crediticia aprobada.",
                            "Todos los despachos se realizan en la direcci√≥n provista en la Orden de Compra. Cualquier modificaci√≥n de la direcci√≥n de despacho deber√° comunicarse oportunamente mediante un correo electr√≥nico a LG Electronics Chile Ltda.",
                            "Todos los productos se entregan sobre la plataforma del cami√≥n. Es responsabilidad del cliente gestionar los permisos correspondientes en obra y disponer de la maquinaria, plataformas, herramientas y espacios necesarios para la correcta descarga del equipamiento por parte del especialista contratado en obra.",
                            "Cualquier reclamo, una vez entregado el equipo en la direcci√≥n indicada en la Orden de Compra respecto al mismo, se encuentra cubierto por la garant√≠a. Por consiguiente, no se generar√° penalidad alguna por la demora en la entrega, instalaci√≥n o puesta en marcha."
                        ]
                    },
                    {
                        title: "FORMA DE PAGO",
                        points: [
                            "Conforme al valor observado por el Banco Central del d√≥lar o pesos chilenos.",
                            "Seg√∫n acuerdo comercial entre LG Electronics Chile Ltda. y el cliente.",
                            "Los precios y disponibilidades consignados en esta cotizaci√≥n est√°n sujetos a los modelos y cantidades del dise√±o o solicitud correspondiente. Cualquier modificaci√≥n estar√° sujeta a revisi√≥n y nueva cotizaci√≥n si aplica.",
                            "El plazo de pago comienza desde la fecha de emisi√≥n de la factura."
                        ]
                    },
                    {
                        title: "VALIDEZ DE OFERTA",
                        points: [
                            "15 d√≠as calendario desde la fecha de generaci√≥n de la cotizaci√≥n, hasta agotar stock o hasta emisi√≥n de nuevo listado de precios por LG Electronics."
                        ]
                    },
                    {
                        title: "PRECAUCIONES",
                        points: [
                            "El instalador, una vez reciba el equipamiento, deber√° indicar fechas estimadas para comenzar el proceso de Commissioning. La re coordinaci√≥n o anulaci√≥n de las asistencias y visitas se deber√°n informar directamente al equipo de servicio con al menos un mes de anticipaci√≥n; de lo contrario, se considerar√°n como servicio prestado. Por tanto, en caso de requerir una nueva fecha, se deber√° solicitar un presupuesto adicional y disponibilidad al equipo de servicio por estas visitas y trabajos.",
                            "Es responsabilidad de la empresa instaladora ejecutar los trabajos conforme a los manuales de instalaci√≥n, ingenier√≠a y est√°ndares locales e internacionales.",
                            "Es responsabilidad de la empresa instaladora enviar al equipo de Commissioning los diagramas actualizados de ca√±er√≠as, fuerza y control para cargar la cantidad de refrigerante adecuada."
                        ]
                    }
                ];

                // --- Helper for Justified Text with Bullets ---
                const printJustifiedListItem = (text, startX, currentY, maxWidth) => {
                    const bullet = "‚Ä¢";
                    const textX = startX + 4;
                    const textWidth = maxWidth - 4;

                    // Calculate height
                    const dims = doc.getTextDimensions(text, { maxWidth: textWidth, fontSize: 9 });
                    const h = dims.h; // approximate height

                    checkPage(h);

                    doc.text(bullet, startX, y);
                    doc.text(text, textX, y, { maxWidth: textWidth, align: "justify" });

                    // Update y
                    y += h + 2;
                };

                const printJustifiedParagraph = (text, startX, currentY, maxWidth) => {
                    const dims = doc.getTextDimensions(text, { maxWidth: maxWidth, fontSize: 9 });
                    const h = dims.h;
                    checkPage(h);
                    doc.text(text, startX, y, { maxWidth: maxWidth, align: "justify" });
                    y += h + 3;
                };

                doc.setFont("helvetica", "normal");
                doc.setFontSize(9);
                doc.setTextColor(0, 0, 0);

                conditionsData.forEach(section => {
                    checkPage(10);
                    if (section.title) {
                        doc.setFont("helvetica", "bold");
                        doc.setFontSize(9);
                        doc.text(section.title, 14, y);
                        y += 5;
                    }

                    doc.setFont("helvetica", "normal");

                    section.points.forEach(point => {
                        printJustifiedListItem(point, 14, y, 180);
                    });
                    y += 2;
                });

                // --- ANEXO A ---
                doc.addPage();
                y = 35; // Increased margin
                doc.setFont("helvetica", "bold");
                doc.setFontSize(10);
                doc.text("ANEXO A:", 14, y); y += 10;

                doc.text("LG ELECTRONICS INC. CHILE LTDA.", 105, y, { align: 'center' }); y += 5;
                doc.text("GARANT√çA LG CAC", 105, y, { align: 'center' }); y += 10;

                doc.setFont("helvetica", "normal");
                doc.setFontSize(9);

                const anexoIntro = "Si su equipo acondicionador de aire tipo VRF-Multi V 5 resultara defectuoso debido a causas asociadas a los materiales y mano de obra utilizados durante la fabricaci√≥n, LG Electronics inc. Chile Ltda. (LGECL) reemplazar√° la(s) piezas(s) defectuosa(s). La(s) pieza(s) de repuesto que se utilizar√°n ser√° piezas originales fabricadas para este prop√≥sito. La(s) pieza(s) de repuesto estar√° garantizada por el tiempo restante del per√≠odo de garant√≠a original.";
                printJustifiedParagraph(anexoIntro, 14, y, 180);

                doc.setFont("helvetica", "bold");
                doc.text("Condiciones de garant√≠a:", 14, y); y += 5;
                doc.setFont("helvetica", "normal");

                const garantiaPoints = [
                    "1. LGECL garantiza los productos LG instalados en el proyecto por defectos en los materiales y mano de obra durante la fabricaci√≥n del equipo bajo uso normal y apropiado de acuerdo a los manuales y directrices aplicables expedidas por el fabricante.",
                    "2. Los equipos deben ser instalados por personal capacitado y entrenado al menos seis meses antes del inicio de los trabajos, siguiendo los procedimientos indicados por el fabricante para este fin.",
                    "3. La puesta en marcha de los equipos debe ser realizada por personal de LGECL o un agente autorizado por LGECL, siguiendo los procedimientos indicados por el fabricante para este fin. Dicha puesta en marcha de ser realizada en un periodo no mayor a 12 meses, luego de recibidos los equipos en el proyecto.",
                    "4. Los equipos deben ser mantenidos por personal capacitado y entrenado al menos seis meses antes del inicio de los trabajos para este fin. Durante todo el per√≠odo de garant√≠a y se debe guardar un registro detallado de los mismos.",
                    "5. En caso de que la puesta en marcha sea realizada por alg√∫n agente autorizado por LGECL, es necesario que este env√≠e toda la informaci√≥n solicitada por el fabricante para la validaci√≥n de la garant√≠a.",
                    "6. LGECL garantiza el servicio t√©cnico contra cualquier defecto de f√°brica durante el periodo de cobertura indicado en este certificado. LGECL asignar√° cualquiera de los Centros Autorizados para este fin."
                ];
                garantiaPoints.forEach(p => printJustifiedParagraph(p, 14, y, 180));
                y += 2;

                doc.setFont("helvetica", "bold");
                doc.text("Periodo de garant√≠a:", 14, y); y += 5;
                doc.setFont("helvetica", "normal");

                const periodoPoints = [
                    "1. 12 meses (1) a√±o de garant√≠a en partes comenzando a partir de la fecha de arranque y puesta en marcha de los equipos por personal autorizado para este fin, previa confirmaci√≥n y aceptaci√≥n por parte de LGECL, o 24 meses (2) a√±os contados a partir de la venta de los equipos por parte de LGECL, lo que ocurra primero.",
                    "2. 24 meses (2) a√±os en el compresor contados a partir de la fecha de arranque y puesta en marcha de los equipos por personal autorizado para este fin, previa confirmaci√≥n y aceptaci√≥n por parte de LGECL, o 24 meses (2) a√±os contados a partir de la venta de los equipos por parte de LGECL, lo que ocurra primero."
                ];
                periodoPoints.forEach(p => printJustifiedParagraph(p, 14, y, 180));
                y += 2;

                // --- EXCLUSIONES (Esta garant√≠a no cubre) ---
                checkPage(10);
                doc.setFont("helvetica", "bold");
                doc.text("Esta garant√≠a no cubre:", 14, y); y += 5;
                doc.setFont("helvetica", "normal");

                const exclusionesPoints = [
                    "1. Viajes de servicio para recolecci√≥n o entrega, instalaci√≥n, emisi√≥n de instrucciones o reemplazo de fusibles, o conexi√≥n de alambrado o plomer√≠a, o correcci√≥n de reparaciones no autorizadas.",
                    "2. Errores relacionados con c√°lculo de carga t√©rmica, selecci√≥n de equipos, faltas en el procedimiento de instalaci√≥n, dimensionamiento incorrecto de ductos o cualquier otra falta relacionada con los est√°ndares y normas establecidas para dise√±o e instalaci√≥n de equipos de aire acondicionado.",
                    "3. Fallas del producto ocurridas durante eventos el√©ctricos (‚Äúsag‚Äù, ‚Äúswell‚Äù, transitorios de voltajes, desbalance de voltaje), interrupciones, inadecuado servicio el√©ctrico o cualquier otro disturbio el√©ctrico asociado.",
                    "4. Da√±os causados por errores de selecci√≥n, dimensionamiento de tuber√≠as, problemas en la instalaci√≥n, y acciones no aprobadas o especificadas por LGECL o el fabricante Anexo A.1 El di√°metro/tuber√≠as debe cumplir con el reporte de ca√±er√≠as fuerza y control del sistema modificado (Referencia: LATS HVAC).",
                    "5. Da√±os relacionados con el manejo o transporte.",
                    "6. Da√±os al producto causados por accidentes, plagas, rayos, viento, fuego, inundaciones u otros actos de la naturaleza.",
                    "7. Da√±os causados por fugas o roturas de tuber√≠as de agua, tuber√≠as de refrigerante o l√≠neas de drenaje.",
                    "8. Da√±os causados por flujo inadecuado de aire.",
                    "9. Reparaciones cuando el producto es utilizado para fines ajenos al uso normal o contrario a las instrucciones descritas en el manual del propietario.",
                    "10. Da√±os causados por accidentes, mal uso, abuso o instalaci√≥n, reparaci√≥n o mantenimiento inadecuado. Reparaciones inadecuadas que incluyan el uso de partes no aprobadas o especificadas por LGECL o el fabricante.",
                    "11. Da√±os ocasionados al producto por atmosfera corrosiva.",
                    "12. Da√±os causados por no cumplir con el mantenimiento, como se describe en las instrucciones de instalaci√≥n y manual de uso y cuidado, tales como sustituci√≥n de filtros, limpieza de intercambiadores, etc.",
                    "13. Uso de accesorios o componentes que no son compatibles con el sistema.",
                    "14. Productos con alteraci√≥n o remoci√≥n de los n√∫meros de serie.",
                    "15. Cambios en la apariencia del producto que no afectan el rendimiento del mismo.",
                    "16. Cambios en el consumo el√©ctrico.",
                    "17. Tubos de cables, cintas, materiales aislantes y otros materiales o componentes proporcionados por terceros y / o perjuicios causados por √©stas.",
                    "18. Da√±os, p√©rdidas o mal funcionamiento causado por selecci√≥n inapropiada de la capacidad.",
                    "19. Da√±os en accesorios, incluyendo, pero no limitado a las unidades de control remoto, entradas/salidas de las mangueras, los mandos de control, enchufes y cables el√©ctricos, y otras piezas desmontables/ o accesorios.",
                    "20. Cualquier da√±o a la propiedad, incluyendo, pero no limitado a los gabinetes, estantes, bandejas, art√≠culos de comida o ropa, que surjan de o en conexi√≥n con el uso de los productos o cualquier mal funcionamiento o defecto en el sistema de aire acondicionado.",
                    "21. El costo de proporcionar acceso a cualquier sistema de aire acondicionado por todos los medios necesarios con el prop√≥sito de realizar las reparaciones o mantenimiento en el caso de que el lugar o posici√≥n en la que est√° instalado el sistema de acondicionamiento de aire es tal que no hay acceso razonable para realizar reparaciones o mantenimiento.",
                    "22. Cualquier da√±o a la propiedad causados en el proceso de llevar a cabo la reparaci√≥n o el mantenimiento del sistema de aire acondicionado instalado en posiciones o lugares que dificulten de manera razonable evitar da√±os."
                ];
                exclusionesPoints.forEach(p => printJustifiedParagraph(p, 14, y, 180));
                y += 2;

                const finalText = "Por la presente se dispone expresamente que cualquier responsabilidad de LG Electronics Inc. Chile Ltda. y/o fabricante no deber√° exceder los precios de compra (sin incluir el costo de instalaci√≥n) del producto (s) objeto de la reclamaci√≥n. Esta garant√≠a no ser√° aplicable respecto de cualquier producto que haya sido alterado, o que ha sido objeto de reparaci√≥n, ajuste o servicio por personas distintas de las autorizadas por LG Electronics Inc. Chile Ltda. para hacerlo.";
                printJustifiedParagraph(finalText, 14, y, 180);

                // --- Helper: Draw Vector LG Logo ---
                const drawLGLogo_UNUSED = (doc, x, y, size) => {
                    // Main Red Circle
                    doc.setFillColor(165, 0, 52); // LG Red
                    doc.circle(x + size / 2, y + size / 2, size / 2, 'F');

                    doc.setDrawColor(255, 255, 255);
                    doc.setLineWidth(size * 0.08);
                    doc.setLineCap('round');

                    // "L" Shape
                    const lX = x + size * 0.45;
                    const lY = y + size * 0.25;
                    const lW = size * 0.25;
                    const lH = size * 0.5;

                    doc.line(lX, lY, lX, lY + lH); // Vertical
                    doc.line(lX, lY + lH, lX + lW, lY + lH); // Horizontal

                    // "Dot"
                    doc.setFillColor(255, 255, 255);
                    doc.circle(x + size * 0.35, y + size * 0.35, size * 0.07, 'F');

                    // Text "LG"
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(size * 2.5); // Approx 30pt for size 12
                    doc.setTextColor(128, 128, 128); // Dark Grey
                    doc.text("LG", x + size * 1.2, y + size * 0.85);
                };

                // --- FOOTER AND HEADER (All Pages) ---
                const totalPages = doc.internal.getNumberOfPages();
                const footerPageWidth = doc.internal.pageSize.width;
                const footerPageHeight = doc.internal.pageSize.height;

                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);

                    // HEADER: Logo on every page
                    printHeaderLogo();

                    // FOOTER
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(8);
                    doc.setTextColor(128, 128, 128); // Grey

                    const footerText = "Edificio Deloitte | Rosario Norte 407 | Piso 10 | Las Condes | Santiago de Chile";
                    doc.text(footerText, footerPageWidth / 2, footerPageHeight - 10, { align: "center" });

                    const pageNum = `${i} de ${totalPages}`;
                    doc.text(pageNum, footerPageWidth - 14, footerPageHeight - 10, { align: "right" });
                }

                doc.save(`Cotizacion_${q.quote_code}.pdf`);

            } catch (err) {
                console.error(err);
                alert("Error: " + err.message);
            }
        };

        // --- SEARCH ---
        function setupSearch() {
            const i = document.getElementById('productSearch');
            let t;
            i.addEventListener('input', e => { clearTimeout(t); t = setTimeout(() => doSearch(e.target.value), 300) });
            document.getElementById('btnSearch').onclick = () => doSearch(i.value);
            i.addEventListener('keypress', e => { if (e.key === 'Enter') doSearch(i.value) });
        }
        // Call setupSearch when the DOM is ready, or at the end of the script
        // setupSearch(); // Uncomment if you want to call it here

        async function doSearch(v) {
            v = v.trim(); const d = document.getElementById('searchResults');
            if (v.length < 2) { d.style.display = 'none'; return; }
            const { data: p } = await db.from('products').select('*').or(`model_suffix.ilike.%${v}%,model_short.ilike.%${v}%`).limit(10);
            d.innerHTML = ''; d.style.display = 'block';
            if (p && p.length) p.forEach(x => { let e = document.createElement('div'); e.className = 'result-item'; e.textContent = x.model_short; e.onclick = () => { window.addItem(x) }; d.appendChild(e) });
            else d.innerHTML = '<div style="padding:10px">Sin resultados</div>';
        }
        window.addItem = (p) => {
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('productSearch').value = '';
            const d = isAdmin ? 0 : (myDiscounts[p.category] || 0);
            quoteItems.push({ product: p, qty: 1, disc: d, net: 0, delivery_date: '' });
            recalc(quoteItems.length - 1);
        }
        window.updateDisc = (i, v) => { quoteItems[i].disc = parseFloat(v) || 0; recalc(i); }
        window.updateQty = (i, v) => { quoteItems[i].qty = parseInt(v) || 1; recalc(i); }
        window.updateDate = (i, v) => { quoteItems[i].delivery_date = v; }
        window.removeItem = (i) => { quoteItems.splice(i, 1); render(); }
        function recalc(i) { const x = quoteItems[i]; x.net = x.product.list_price * ((100 - x.disc) / 100); render(); }
        // Helper for currency
        const fmt = (num) => {
            return '$' + parseFloat(num || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        function render() {
            const tb = document.querySelector('#quoteTable tbody');
            tb.innerHTML = '';
            let t = 0;

            quoteItems.forEach((x, i) => {
                t += x.net * x.qty;
                const tr = document.createElement('tr');

                // Input styles for better UI
                const inputStyle = "width:100%; padding:5px; border:1px solid #ddd; border-radius:4px;";

                tr.innerHTML = `
                <td style="font-weight:500">${x.product.model_short}</td>
                <td style="max-width:200px;">
                    <div style="font-size:0.85em; color:#666; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; text-overflow:ellipsis; line-height: 1.2em; height: 2.4em;">
                        ${x.product.description || '--'}
                    </div>
                </td>
                
                <!-- Delivery Date with Copy option support -->
                <td>
                    <input type="date" value="${x.delivery_date}" 
                           style="${inputStyle} width:130px;" 
                           onchange="window.updateDate(${i},this.value)"
                           placeholder="YYYY-MM-DD">
                </td>
                
                <td style="text-align:right;">${fmt(x.product.list_price)}</td>
                
                <td style="width:70px; text-align:center; background-color:#f9f9f9; color:#666;">
                    ${x.disc}%
                </td>
                
                <td style="text-align:right; font-weight:600;">${fmt(x.net)}</td>
                
                <td style="width:70px">
                    <input type="number" value="${x.qty}" 
                           style="${inputStyle} text-align:center;" 
                           onchange="window.updateQty(${i},this.value)" min="1">
                </td>
                
                <td style="text-align:right; font-weight:700; color:#A50034;">${fmt(x.net * x.qty)}</td>
                
                <td style="text-align:center;">
                    <button onclick="window.removeItem(${i})" 
                            style="color:white; background:#ff4d4f; border:none; border-radius:4px; width:24px; height:24px; cursor:pointer;" 
                            title="Eliminar l√≠nea">√ó</button>
                </td>`;
                tb.appendChild(tr);
            });
            document.getElementById('grandTotal').textContent = fmt(t);
        }

        // New Feature: Fill Dates
        window.fillDates = () => {
            if (quoteItems.length === 0) return;
            const firstDate = quoteItems[0].delivery_date;
            if (!firstDate) return alert("Ingresa una fecha en el primer √≠tem para copiarla a los dem√°s.");

            quoteItems.forEach(x => x.delivery_date = firstDate);
            render();
        };

        async function saveQuote() {
            if (!quoteItems.length) return alert("La cotizaci√≥n est√° vac√≠a. Agrega al menos un producto.");

            // 1. Validate Head Fields
            const projectName = document.getElementById('projectName').value.trim();
            const clientId = document.getElementById('clientSelect').value;
            const awardDateVal = document.getElementById('awardDate').value;

            if (!projectName) return alert("Por favor, ingresa el Nombre del Proyecto.");
            if (!clientId) return alert("Por favor, selecciona un Cliente.");
            if (!awardDateVal) return alert("Por favor, selecciona la Fecha Award.");

            // 2. Validate Items & Dates
            const awardDate = new Date(awardDateVal);
            for (let i = 0; i < quoteItems.length; i++) {
                const item = quoteItems[i];
                if (!item.delivery_date) {
                    return alert(`El √≠tem #${i + 1} (${item.product.model_short}) no tiene Fecha de Entrega.`);
                }
                if (item.qty <= 0) {
                    return alert(`El √≠tem #${i + 1} tiene cantidad 0 or negativa.`);
                }

                const deliveryDate = new Date(item.delivery_date);
                if (deliveryDate < awardDate) {
                    return alert(`Error en √≠tem #${i + 1} (${item.product.model_short}): \nLa Fecha de Entrega(${item.delivery_date}) NO puede ser anterior a la Fecha Award(${awardDateVal}).`);
                }
            }

            const btn = document.getElementById('btnSave');
            btn.textContent = "Guardando..."; btn.disabled = true;

            try {
                const tot = quoteItems.reduce((a, b) => a + (b.net * b.qty), 0);

                let currentStage = document.getElementById('quoteStage').value;
                let lossReason = null;

                // INTERCEPT LOST STATUS FOR NON-ADMINS
                if (currentStage === 'Lost' && !isAdmin) {
                    if (!confirm("Marcar una oportunidad como 'Lost' (Perdida) requiere aprobaci√≥n del administrador. \n\n¬øDesea enviar la solicitud de baja ahora?")) {
                        btn.textContent = "Guardar Cotizaci√≥n"; btn.disabled = false;
                        return; // Cancel save
                    }
                    lossReason = prompt("Por favor ingrese la raz√≥n de p√©rdida:");
                    if (!lossReason) {
                        alert("Debe ingresar una raz√≥n para solicitar la baja.");
                        btn.textContent = "Guardar Cotizaci√≥n"; btn.disabled = false;
                        return;
                    }
                    currentStage = 'Lost_Pending';
                }

                const qData = {
                    user_id: currentUser.id, distributor_id: myDistributorId,
                    project_name: projectName,
                    client_id: clientId,
                    quote_code: document.getElementById('quoteCode').value,
                    award_date: awardDateVal, total_net_price: tot, status: 'draft',
                    stage: currentStage,
                    loss_reason: lossReason, // Add loss reason if applicable
                    requested_by: currentUser.id, // Ensure requester is tracked
                    consultant_id: document.getElementById('consultantSelect').value || null,
                    is_spec_in: document.getElementById('chkSpecIn').checked,
                    is_retrofit: document.getElementById('chkRetrofit').checked,
                    // Duplicated fields removed
                    specified_brands: window.getSelectedBrandArray()
                };

                let qId;
                if (currentQuoteId) {
                    // Update
                    const { error: ue } = await db.from('quotes').update(qData).eq('id', currentQuoteId);
                    if (ue) throw ue;
                    qId = currentQuoteId;
                    await db.from('quote_items').delete().eq('quote_id', qId);
                } else {
                    // Insert
                    const { data: q, error: ie } = await db.from('quotes').insert([qData]).select().single();
                    if (ie) throw ie;
                    qId = q.id;
                }

                const items = quoteItems.map(x => ({
                    quote_id: qId, product_id: x.product.id, quantity: x.qty,
                    unit_list_price: x.product.list_price, applied_discount: x.disc,
                    final_unit_price: x.net, total_line_price: x.net * x.qty,
                    delivery_date: x.delivery_date || null
                }));
                const { error: ie } = await db.from('quote_items').insert(items);
                if (ie) throw ie;

                alert("Guardado!");
                showList();
            } catch (err) {
                alert("Error: " + err.message);
            } finally {
                btn.textContent = "Guardar Cotizaci√≥n"; btn.disabled = false;
            }
        }
        // ... existing saveQuote ...

        window.deleteQuote = async (id) => {
            if (!confirm("¬øEst√°s seguro de ELIMINAR esta cotizaci√≥n completa? Esta acci√≥n no se puede deshacer.")) return;

            // 1. Delete Items
            const { error: iErr } = await db.from('quote_items').delete().eq('quote_id', id);
            if (iErr) return alert("Error borrando items: " + iErr.message);

            // 2. Delete Quote
            const { error: qErr } = await db.from('quotes').delete().eq('id', id);
            if (qErr) return alert("Error borrando cotizaci√≥n: " + qErr.message);

            alert("Eliminado.");
            // Reload list
            loadRecentQuotes();
        }

        window.loadConsultants = async () => {
            const s = document.getElementById('consultantSelect');
            let q = db.from('clients').select('id, company_name').eq('is_consultant', true); // Filter only consultants
            if (!isAdmin) q = q.eq('distributor_id', myDistributorId);

            const { data: c } = await q;
            s.innerHTML = '<option value="">Sin Consultor / N/A</option>';
            if (c) {
                c.forEach(x => {
                    let o = document.createElement('option');
                    o.value = x.id;
                    o.textContent = x.company_name;
                    s.appendChild(o)
                });
            }
        };

        window.getSelectedBrandArray = () => {
            const sel = document.getElementById('brandSelect');
            const inp = document.getElementById('brandOtherInput');
            if (sel.value === 'Otros') {
                return inp.value ? [inp.value.trim()] : [];
            }
            return sel.value ? [sel.value] : [];
        };

        window.checkBrandOther = () => {
            const val = document.getElementById('brandSelect').value;
            const inp = document.getElementById('brandOtherInput');
            if (val === 'Otros') {
                inp.style.display = 'block';
                inp.focus();
            } else {
                inp.style.display = 'none';
                inp.value = '';
            }
        };

        // --- NEW HELPERS ---
        window.loadBrands = async () => {
            const select = document.getElementById('brandSelect');
            try {
                let brandsToRender = [];
                // Try fetch from DB
                const { data: brands, error } = await db.from('brands').select('name').eq('active', true);

                if (error || !brands || brands.length === 0) {
                    console.warn("Using default brands list due to error or empty DB:", error);
                    brandsToRender = ['Samsung', 'Daikin', 'Trane', 'Anwo', 'Clark', 'Climaveneta', 'Euroklimat', 'JCI'];
                } else {
                    brandsToRender = brands.map(b => b.name);
                }

                select.innerHTML = '<option value="">Seleccione Marca...</option>';
                brandsToRender.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b;
                    opt.textContent = b;
                    select.appendChild(opt);
                });

                // Add Others
                const otherOpt = document.createElement('option');
                otherOpt.value = 'Otros';
                otherOpt.textContent = 'Otros / Escribir...';
                select.appendChild(otherOpt);

            } catch (e) {
                console.error("Critical error loading brands", e);
            }
        };



        window.toggleBrands = () => {
            const isSpecIn = document.getElementById('chkSpecIn').checked;
            const brandsDiv = document.getElementById('brandsContainer');
            const successDiv = document.getElementById('specInSuccess');

            if (!isSpecIn) {
                // Not Spec In -> Show Competitor List
                brandsDiv.classList.remove('hidden');
                brandsDiv.style.display = 'block';
                if (successDiv) successDiv.classList.add('hidden');
            } else {
                // Spec In -> Hide List, Show Success
                brandsDiv.classList.add('hidden');
                brandsDiv.style.display = 'none';
                if (successDiv) successDiv.classList.remove('hidden');
            }
        };

    </script>
</body>

</html>